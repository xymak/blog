---
title: "利用gdb分析nginx core dump文件"
date: 2020-05-02T17:50:57+08:00
draft: false
---

今天学习极客时间《Nginx核心知识100讲》，其中介绍了gdb怎么分析nginx的core dump文件。我在这里记录下来。

首先在nginx.conf中加入core dump文件（核心转储文件）的配置，保证nginx对目录有写权限
```
worker_rlimit_core 90m;
working_directory /tmp/nginxcore/;
```

然后给nginx master发个SIGHUP信号。
```shell script
kill -1 ${PID}
```

给其中有一个worker发送SIGSEGV信号，使nginx生成core dump文件.
```shell script
kill -s SIGSEGV ${PID}
```

然后通过gdb分析现场。
```shell script
gdb nginx core
```
```
GNU gdb (GDB) Red Hat Enterprise Linux 7.6.1-119.el7
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-redhat-linux-gnu".
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>...
Reading symbols from /usr/sbin/nginx...Reading symbols from /usr/sbin/nginx...(no debugging symbols found)...done.
(no debugging symbols found)...done.
[New LWP 12894]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib64/libthread_db.so.1".
Core was generated by `nginx:'.
Program terminated with signal 11, Segmentation fault.
#0  0x00007fd45fca1e93 in __epoll_wait_nocancel () from /lib64/libc.so.6
Missing separate debuginfos, use: debuginfo-install nginx-1.16.1-1.el7.x86_64
(gdb) bt
#0  0x00007fd45fca1e93 in __epoll_wait_nocancel () from /lib64/libc.so.6
#1  0x000055cbdc3019f1 in ngx_epoll_process_events ()
#2  0x000055cbdc2f691a in ngx_process_events_and_timers ()
#3  0x000055cbdc2ff825 in ngx_worker_process_cycle ()
#4  0x000055cbdc2fdc5f in ngx_spawn_process ()
#5  0x000055cbdc300b47 in ngx_master_process_cycle ()
#6  0x000055cbdc2d407b in main ()
(gdb) thread apply all bt

Thread 1 (Thread 0x7fd461536880 (LWP 12894)):
#0  0x00007fd45fca1e93 in __epoll_wait_nocancel () from /lib64/libc.so.6
#1  0x000055cbdc3019f1 in ngx_epoll_process_events ()
#2  0x000055cbdc2f691a in ngx_process_events_and_timers ()
#3  0x000055cbdc2ff825 in ngx_worker_process_cycle ()
#4  0x000055cbdc2fdc5f in ngx_spawn_process ()
#5  0x000055cbdc300b47 in ngx_master_process_cycle ()
#6  0x000055cbdc2d407b in main ()
(gdb) t 1
[Switching to thread 1 (Thread 0x7fd461536880 (LWP 12894))]
#0  0x00007fd45fca1e93 in __epoll_wait_nocancel () from /lib64/libc.so.6
(gdb) f 0
#0  0x00007fd45fca1e93 in __epoll_wait_nocancel () from /lib64/libc.so.6
```
